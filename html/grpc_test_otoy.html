<!DOCTYPE html>
<!-- 
    LiveLink gRPC-Web Test Page
    Technical testing interface for gRPC-Web connection debugging
    Provides detailed connection diagnostics and error handling testing
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ OTOY LiveLink Test Interface</title>
    <link rel="stylesheet" href="otoy-theme.css">
</head>
<body>
    <div class="container">
        <!-- OTOY Branding -->
        <div class="otoy-branding">
            <img src="https://home.otoy.com/wp-content/themes/otoy/assets/images/otoy-logo-white.svg" alt="OTOY" class="otoy-logo" style="width: 40px; height: 40px;">
            <h1>üß™ Octane LiveLink Test Interface</h1>
        </div>
        
        <!-- Ultra-Tight Controls Layout - 2 Horizontal Rows -->
        <div class="controls-container">
            <!-- Row 1: Connection & Debug Controls -->
            <div class="control-row">
                <input type="text" id="serverAddress" placeholder="Server address" value="http://127.0.0.1:51023">
                <button id="connectBtn" onclick="testConnection()">Connect</button>
                <button onclick="disconnect()">Disconnect</button>
                <button onclick="exportDebugInfo()">Export</button>
                <button onclick="showSystemInfo()">System</button>
                <button onclick="showDebugInfo()">Debug</button>
                <button onclick="refreshStats()">Stats</button>
                <button onclick="clearLog()">Clear</button>
            </div>
            
            <!-- Row 2: LiveLink Operations -->
            <div class="control-row">
                <button onclick="testGetCamera()">Get Camera</button>
                <button onclick="testSetCamera()">Set Camera</button>
                <button onclick="testGetMeshes()">Get Meshes</button>
                <button onclick="testGetMesh()">Get Mesh</button>
                <button onclick="testLoadTeapot()">Load Teapot</button>
            </div>
        </div>
        

        
        <!-- Activity Log Only -->
        <div class="content-area">
            <div class="activity-section glass-panel">
                <div class="activity-title">Activity Log</div>
                <div id="log" class="activity-log"></div>
            </div>
        </div>
    </div>

    <!-- Include shared utilities and LiveLink client -->
    <script src="shared.js"></script>
    <script src="livelink.js"></script>
    <script>
        /**
         * LiveLink gRPC Test Interface
         * Simplified testing interface using shared utilities
         */
        
        // Application state
        let client = null;
        let logger = null;
        let statsManager = null;
        let grpcOperations = null;
        let debugUtils = null;

        // Initialize application when page loads
        document.addEventListener('DOMContentLoaded', () => {
            logger = new ActivityLogger('log');
            statsManager = new StatsDisplayManager();
            grpcOperations = new GrpcTestOperations(logger, statsManager);
            debugUtils = new DebugUtils(logger);
            
            // Initialize LED status to "All Systems Ready"
            if (statsManager) {
                statsManager.updateConnectionStatus(false);
            }
            
            logger.log('üîç LiveLink gRPC Test Interface initialized', 'info');
        });

        // Simplified utility functions using shared classes
        function clearLog() {
            if (logger) {
                logger.clear();
                logger.log('Activity log cleared', 'info');
            }
        }

        function updateStatus(status, mode = '') {
            const statusSpan = document.getElementById('connectionStatus');
            const connectBtn = document.getElementById('connectBtn');
            
            if (statusSpan) {
                statusSpan.className = `status-indicator status-${status}`;
                
                switch (status) {
                    case 'connected':
                        statusSpan.textContent = `Connected${mode ? ` (${mode})` : ''}`;
                        break;
                    case 'disconnected':
                        statusSpan.textContent = 'Disconnected';
                        break;
                    case 'error':
                        statusSpan.textContent = 'Connection Error';
                        break;
                    default:
                        statusSpan.textContent = status;
                }
            }

            if (connectBtn) {
                switch (status) {
                    case 'connected':
                        connectBtn.textContent = 'RECONNECT';
                        break;
                    case 'disconnected':
                        connectBtn.textContent = 'CONNECT';
                        break;
                    case 'error':
                        connectBtn.textContent = 'RETRY';
                        break;
                }
            }

            // Update OTOY LED status - detect proxy availability from error type
            if (statsManager) {
                const isProxyError = client && client.lastError && 
                    (client.lastError.message.includes('fetch') || 
                     client.lastError.message.includes('ERR_CONNECTION_REFUSED') ||
                     client.lastError.message.includes('ERR_NETWORK_CHANGED'));
                
                const proxyAvailable = status !== 'error' || !isProxyError;
                statsManager.updateConnectionStatus(status === 'connected', proxyAvailable);
            }
        }

        function updateStats() {
            if (statsManager && client) {
                statsManager.updateStats(client);
            }
        }

        function exportDebugInfo() {
            if (debugUtils && client) {
                debugUtils.exportDebugInfo(client);
            }
        }

        function showSystemInfo() {
            if (debugUtils && client) {
                debugUtils.showSystemInfo(client);
            }
        }

        function showDebugInfo() {
            if (debugUtils && client) {
                debugUtils.showDebugInfo(client);
            }
        }

        async function testConnection() {
            try {
                const serverAddress = document.getElementById('serverAddress').value;
                logger.log('üîó Connecting to Octane LiveLink...', 'info');
                
                client = liveLinkManager.getClient(serverAddress);
                
                // Setup event handlers
                client.removeAllListeners();
                
                client.on('log', (logEntry) => {
                    const displayMessage = logEntry.cleanMessage || logEntry.message;
                    logger.log(displayMessage, logEntry.level);
                });
                
                client.on('connected', () => {
                    logger.log('‚úÖ Connected to Octane LiveLink!', 'success');
                    updateStatus('connected', 'Live');
                    updateStats();
                });
                
                client.on('disconnected', () => {
                    logger.log('Disconnected from server', 'info');
                    updateStatus('disconnected');
                    updateStats();
                });
                
                client.on('error', (error) => {
                    logger.log(`‚ùå Connection error: ${error.message}`, 'error');
                    updateStatus('error');
                    updateStats();
                });
                
                await client.connect();
                
                const stats = client.getStats();
                if (stats.connected) {
                    updateStatus('connected', 'Live');
                } else {
                    updateStatus('error');
                }
                updateStats();
                
            } catch (error) {
                logger.log(`‚ùå Connection error: ${error.message}`, 'error');
                updateStatus('error');
            }
        }

        async function disconnect() {
            if (client) {
                await client.disconnect();
                logger.log('Disconnected from server', 'info');
                updateStatus('disconnected');
                updateStats();
            } else {
                logger.log('No connection to disconnect', 'warning');
            }
        }

        async function testGetCamera() {
            if (grpcOperations && client) {
                await grpcOperations.testGetCamera(client);
            }
        }

        async function testSetCamera() {
            if (grpcOperations && client) {
                const cameraState = {
                    position: { x: Math.random() * 10 - 5, y: Math.random() * 10 - 5, z: 5 },
                    target: { x: 0, y: 0, z: 0 },
                    up: { x: 0, y: 1, z: 0 },
                    fov: 45
                };
                await grpcOperations.testSetCamera(client, cameraState);
            }
        }

        async function testGetMeshes() {
            if (grpcOperations && client) {
                await grpcOperations.testGetMeshes(client);
            }
        }

        async function testGetMesh() {
            if (grpcOperations && client) {
                await grpcOperations.testGetMesh(client);
            }
        }

        async function testLoadTeapot() {
            if (grpcOperations && client) {
                await grpcOperations.testLoadTeapot(client);
            }
        }
    </script>
    
    <!-- Status Footer -->
    <div class="status-footer">
        <div class="footer-stats">
            <span>Status: <span id="connectionStatus" class="status-indicator">Disconnected</span></span>
            <span>Calls: <span id="callCount">0</span></span>
            <span>Response: <span id="lastTime">0ms</span></span>
            <span>Avg: <span id="avgTime">0ms</span></span>
            <span>Mode: <span id="mode">Unknown</span></span>
            <span>Errors: <span id="errorCount">0</span></span>
        </div>
    </div>

    <!-- OTOY Footer -->
    <div class="otoy-footer">
        <div class="otoy-status">
            <span class="status-led"></span>
            <span>All Systems Ready</span>
        </div>
        <div class="otoy-copyright">
            ¬© OTOY Inc. ‚Äì 2020 All Rights Reserved. 
            <a href="https://otoy.com/terms" target="_blank">Terms & Conditions</a> | 
            <a href="https://otoy.com/privacy" target="_blank">OTOY Privacy Policy</a>
        </div>
    </div>
</body>
</html>