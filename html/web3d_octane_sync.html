<!DOCTYPE html>
<!-- 
    WebGL-Octane LiveLink Sync
    3D WebGL viewer with real-time Octane synchronization
    Based on grpc_test.html connection logic with 3D visualization
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔗 WebGL-Octane LiveLink Sync</title>
    <link rel="stylesheet" href="tropical-theme.css">
</head>
<body>
    <div class="container">
        <h1>🔗 WebGL-Octane LiveLink Sync</h1>
        
        <!-- Controls at top in 2 rows -->
        <div class="controls-container">
            <div class="control-section">
                <div class="section-title">Connection</div>
                <div class="button-group">
                    <input type="text" id="serverAddress" placeholder="Server address" value="http://127.0.0.1:51023" style="flex: 1; margin-right: 10px;">
                    <button id="connectBtn" onclick="testConnection()">Connect</button>
                    <button onclick="disconnect()">Disconnect</button>
                </div>
            </div>
            
            <div class="control-section">
                <div class="section-title">LiveLink Operations</div>
                <div class="button-group">
                    <button onclick="testGetCamera()">Get Camera</button>
                    <button onclick="testSetCamera()">Set Camera</button>
                    <button onclick="testGetMeshes()">Get Meshes</button>
                    <button onclick="testGetMesh()">Get Mesh</button>
                    <button onclick="testLoadTeapot()">Load Teapot</button>
                    <button onclick="toggleCameraSync()">Toggle Sync</button>
                </div>
            </div>
        </div>
        
        <div class="controls-container">
            <div class="control-section">
                <div class="section-title">Debug & Testing</div>
                <div class="button-group">
                    <button onclick="exportDebugInfo()">Export Debug</button>
                    <button onclick="showSystemInfo()">System Info</button>
                    <button onclick="showDebugInfo()">Debug Info</button>
                    <button onclick="updateStats()">Refresh Stats</button>
                    <button onclick="clearLog()">Clear Log</button>
                </div>
            </div>
            
            <div class="control-section">
                <div class="section-title">View Controls</div>
                <div class="button-group">
                    <button onclick="toggleAutoRotate()">Toggle Auto-Rotate</button>
                    <button onclick="resetCamera()">Reset Camera</button>
                    <button onclick="loadModel()">Load Model</button>
                </div>
            </div>
        </div>
        
        <!-- 3D Canvas and Info Panel below -->
        <div class="content-area">
            <div class="canvas-container">
                <canvas id="canvas"></canvas>
            </div>
            
            <div class="info-panel">
                <div class="control-section">
                    <div class="section-title">Connection Status</div>
                    <div id="status" class="status-section status-disconnected">
                        <div class="status-text">Disconnected</div>
                    </div>
                </div>
                
                <div class="stats-section glass-panel">
                    <div class="stats-title">Performance Statistics</div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-label">FPS:</span>
                            <span class="stat-value" id="fpsValue">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Frame Time:</span>
                            <span class="stat-value" id="frameTimeValue">0ms</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">gRPC Calls:</span>
                            <span class="stat-value" id="callCount">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Last Response:</span>
                            <span class="stat-value" id="lastTime">0ms</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Avg Response:</span>
                            <span class="stat-value" id="avgTime">0ms</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Sync Rate:</span>
                            <span class="stat-value" id="syncRate">0/s</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Connection Mode:</span>
                            <span class="stat-value" id="mode">Unknown</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Errors:</span>
                            <span class="stat-value" id="errorCount">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="log-section glass-panel">
                    <div class="log-title">Activity Log</div>
                    <div id="log" class="log-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Include shared utilities and LiveLink client -->
    <script src="shared.js"></script>
    <script src="livelink.js"></script>
    <script src="webgl-utils.js"></script>
    <script>
        /**
         * WebGL-Octane LiveLink Sync
         * 3D WebGL viewer with real-time Octane synchronization
         * Based on grpc_test.html connection logic
         */
        
        // Application state
        let client = null;
        let logger = null;
        let statsManager = null;
        let grpcOperations = null;
        let debugUtils = null;
        
        // 3D viewer state
        let canvas = null;
        let gl = null;
        let webglRenderer = null;
        let mouseControls = null;
        let cameraSyncManager = null;
        let autoRotate = false;
        let lastFrameTime = 0;
        let frameCount = 0;
        let fpsUpdateTime = 0;
        
        // Initialize application when page loads
        document.addEventListener('DOMContentLoaded', () => {
            logger = new ActivityLogger('log');
            statsManager = new StatsDisplayManager();
            grpcOperations = new GrpcTestOperations(logger, statsManager);
            debugUtils = new DebugUtils(logger);
            
            // Initialize 3D viewer
            initWebGL();
            
            logger.log('🔗 WebGL-Octane LiveLink Sync initialized', 'info');
        });

        // WebGL initialization and rendering
        function initWebGL() {
            canvas = document.getElementById('canvas');
            if (!canvas) {
                logger.log('❌ Canvas element not found', 'error');
                return;
            }
            
            // Set canvas size
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            try {
                gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                if (!gl) {
                    throw new Error('WebGL not supported');
                }
                
                webglRenderer = new SimpleWebGLRenderer(gl, logger);
                webglRenderer.init();
                
                // Setup mouse controls
                mouseControls = new MouseControls(canvas, webglRenderer, logger);
                
                // Setup camera sync manager
                cameraSyncManager = new CameraSyncManager(webglRenderer, null, logger);
                
                // Start render loop
                requestAnimationFrame(renderLoop);
                
                logger.log('✅ WebGL initialized successfully', 'success');
                
            } catch (error) {
                logger.log(`❌ WebGL initialization failed: ${error.message}`, 'error');
            }
        }
        
        function resizeCanvas() {
            if (!canvas) return;
            
            const container = canvas.parentElement;
            const rect = container.getBoundingClientRect();
            
            canvas.width = rect.width;
            canvas.height = rect.height;
            
            if (gl) {
                gl.viewport(0, 0, canvas.width, canvas.height);
            }
            
            if (webglRenderer) {
                webglRenderer.updateProjection(canvas.width, canvas.height);
            }
        }
        
        function renderLoop(currentTime) {
            if (webglRenderer) {
                // Update FPS
                frameCount++;
                if (currentTime - fpsUpdateTime >= 1000) {
                    const fps = Math.round((frameCount * 1000) / (currentTime - fpsUpdateTime));
                    document.getElementById('fpsValue').textContent = fps;
                    frameCount = 0;
                    fpsUpdateTime = currentTime;
                }
                
                // Update frame time
                const frameTime = currentTime - lastFrameTime;
                document.getElementById('frameTimeValue').textContent = Math.round(frameTime) + 'ms';
                lastFrameTime = currentTime;
                
                // Auto-rotate if enabled
                if (autoRotate) {
                    webglRenderer.rotateCamera(currentTime * 0.001);
                }
                
                // Render frame
                webglRenderer.render();
                
                // Sync camera with Octane if enabled
                if (cameraSyncManager) {
                    cameraSyncManager.syncToOctane();
                }
            }
            
            requestAnimationFrame(renderLoop);
        }

        // Connection functions (based on grpc_test.html)
        function updateStatus(status, mode = '') {
            const statusDiv = document.getElementById('status');
            const connectBtn = document.getElementById('connectBtn');
            
            statusDiv.className = `status-section status-${status}`;
            
            switch (status) {
                case 'connected':
                    statusDiv.innerHTML = `<div>Connected${mode ? ` (${mode})` : ''}</div>`;
                    connectBtn.textContent = 'Reconnect';
                    break;
                case 'disconnected':
                    statusDiv.innerHTML = '<div>Disconnected</div>';
                    connectBtn.textContent = 'Connect';
                    break;
                case 'error':
                    statusDiv.innerHTML = '<div>Connection Error</div>';
                    connectBtn.textContent = 'Retry';
                    break;
                default:
                    statusDiv.innerHTML = `<div>${status}</div>`;
            }
        }

        function updateStats() {
            if (statsManager && client) {
                statsManager.updateStats(client);
            }
        }

        function clearLog() {
            if (logger) {
                logger.clear();
                logger.log('Activity log cleared', 'info');
            }
        }

        function exportDebugInfo() {
            if (debugUtils && client) {
                debugUtils.exportDebugInfo(client);
            }
        }

        function showSystemInfo() {
            if (debugUtils && client) {
                debugUtils.showSystemInfo(client);
            }
        }

        function showDebugInfo() {
            if (debugUtils && client) {
                debugUtils.showDebugInfo(client);
            }
        }

        async function testConnection() {
            try {
                const serverAddress = document.getElementById('serverAddress').value;
                logger.log('🔗 Connecting to Octane LiveLink...', 'info');
                
                client = liveLinkManager.getClient(serverAddress);
                
                // Setup event handlers
                client.removeAllListeners();
                
                client.on('log', (logEntry) => {
                    const displayMessage = logEntry.cleanMessage || logEntry.message;
                    logger.log(displayMessage, logEntry.level);
                });
                
                client.on('connected', () => {
                    logger.log('✅ Connected to Octane LiveLink!', 'success');
                    updateStatus('connected', 'Live');
                    updateStats();
                    
                    // Update camera sync manager with client
                    if (cameraSyncManager) {
                        cameraSyncManager.client = client;
                    }
                });
                
                client.on('disconnected', () => {
                    logger.log('Disconnected from server', 'info');
                    updateStatus('disconnected');
                    updateStats();
                });
                
                client.on('error', (error) => {
                    logger.log(`❌ Connection error: ${error.message}`, 'error');
                    updateStatus('error');
                    updateStats();
                });
                
                await client.connect();
                
                const stats = client.getStats();
                if (stats.connected) {
                    updateStatus('connected', 'Live');
                } else {
                    updateStatus('error');
                }
                updateStats();
                
            } catch (error) {
                logger.log(`❌ Connection error: ${error.message}`, 'error');
                updateStatus('disconnected');
            }
        }

        async function disconnect() {
            if (client) {
                await client.disconnect();
                logger.log('Disconnected from server', 'info');
                updateStatus('disconnected');
                updateStats();
            } else {
                logger.log('No connection to disconnect', 'warning');
            }
        }

        // LiveLink operations (based on grpc_test.html)
        async function testGetCamera() {
            if (grpcOperations && client) {
                const cameraData = await grpcOperations.testGetCamera(client);
                if (cameraData && webglRenderer) {
                    webglRenderer.setCameraFromOctane(cameraData);
                }
            }
        }

        async function testSetCamera() {
            if (grpcOperations && client && webglRenderer) {
                const cameraState = webglRenderer.getCameraState();
                await grpcOperations.testSetCamera(client, cameraState);
            }
        }

        async function testGetMeshes() {
            if (grpcOperations && client) {
                await grpcOperations.testGetMeshes(client);
            }
        }

        async function testGetMesh() {
            if (grpcOperations && client) {
                const meshData = await grpcOperations.testGetMesh(client);
                if (meshData && webglRenderer) {
                    webglRenderer.loadMeshData(meshData);
                }
            }
        }

        async function testLoadTeapot() {
            if (grpcOperations && client) {
                await grpcOperations.testLoadTeapot(client);
            }
        }

        // 3D viewer controls
        function toggleAutoRotate() {
            autoRotate = !autoRotate;
            logger.log(`Auto-rotate ${autoRotate ? 'enabled' : 'disabled'}`, 'info');
        }

        function resetCamera() {
            if (webglRenderer) {
                webglRenderer.resetCamera();
                logger.log('Camera reset to default position', 'info');
            }
        }

        function toggleCameraSync() {
            if (cameraSyncManager) {
                const enabled = cameraSyncManager.toggle();
                document.getElementById('syncRate').textContent = enabled ? 'Active' : '0/s';
            }
        }

        function loadModel() {
            // Create file input for model loading
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.obj,.ply,.stl';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file && webglRenderer) {
                    webglRenderer.loadModelFile(file);
                    logger.log(`Loading model: ${file.name}`, 'info');
                }
            };
            input.click();
        }


    </script>


</body>
</html>